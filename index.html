<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ù‚Ø¨Ù„Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© | Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù„Ø§Ù„ÙŠ</title>
    <style>
        :root { --gold: #d4af37; --green: #27ae60; --dark: #1a2a3a; }
        body { font-family: 'Segoe UI', sans-serif; background: #ffffff; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }
        
        .qibla-wrapper { position: relative; width: 280px; height: 280px; display: flex; justify-content: center; align-items: center; }
        .outer-ring { position: absolute; width: 240px; height: 240px; border: 10px solid var(--green); border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .target-arrow { position: absolute; top: -25px; width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 25px solid #e74c3c; z-index: 10; }
        
        .kaaba-pivot { position: absolute; width: 100%; height: 100%; will-change: transform; z-index: 5; }
        .kaaba-icon { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 45px; }
        
        .info-panel { text-align: center; margin-top: 40px; padding: 0 20px; }
        #direction-text { font-size: 18px; font-weight: bold; color: var(--dark); margin-bottom: 10px; }
        
        .btn-designer { background: var(--gold); color: white; border: none; padding: 10px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; margin: 5px; }
        .btn-calibrate { background: var(--dark); color: white; border: none; padding: 8px 15px; border-radius: 10px; font-size: 12px; cursor: pointer; }
        
        .perfect { filter: drop-shadow(0 0 15px #ffd700); transform: translateX(-50%) scale(1.1); transition: 0.3s; }
    </style>
</head>
<body>

    <div class="qibla-wrapper">
        <div class="target-arrow"></div>
        <div class="outer-ring"></div>
        <div class="kaaba-pivot" id="kaabaPivot">
            <div class="kaaba-icon" id="kaabaImg">ðŸ•‹</div>
        </div>
    </div>

    <div class="info-panel">
        <div id="direction-text">Ø§Ù†ØªØ¸Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ù…ÙƒØ©...</div>
        <button class="btn-designer" onclick="alert('Ø¥Ù‡Ø¯Ø§Ø¡ Ù„Ù„Ø¬Ù…ÙŠØ¹ - Ø§Ù„Ù…ØµÙ…Ù… Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù„Ø§Ù„ÙŠ')">Ø§Ù„Ù…ØµÙ…Ù… Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù„Ø§Ù„ÙŠ</button>
        <br>
        <button class="btn-calibrate" onclick="location.reload()">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© ðŸ”„</button>
    </div>

<script>
    const pivot = document.getElementById('kaabaPivot');
    const kaabaImg = document.getElementById('kaabaImg');
    const dirText = document.getElementById('direction-text');
    
    let qiblaAngle = 0;
    let currentHeading = 0;
    let targetHeading = 0;
    const lerpSpeed = 0.08; 

    const kaabaLoc = { lat: 21.4225, lng: 39.8262 };

    function getQiblaAngle(lat, lng) {
        const phiK = kaabaLoc.lat * Math.PI / 180;
        const lambdaK = kaabaLoc.lng * Math.PI / 180;
        const phi = lat * Math.PI / 180;
        const lambda = lng * Math.PI / 180;
        const y = Math.sin(lambdaK - lambda);
        const x = Math.cos(phi) * Math.tan(phiK) - Math.sin(phi) * Math.cos(lambdaK - lambda);
        // Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ù† Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø¨Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙƒØ¹Ø¨Ø©
        return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
    }

    navigator.geolocation.getCurrentPosition(pos => {
        qiblaAngle = getQiblaAngle(pos.coords.latitude, pos.coords.longitude);
        dirText.innerText = "Ø¶Ø¹ Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ø³Ø·Ø­Ø§Ù‹ ÙˆØ§Ø¯Ø± Ø¬Ø³Ù…Ùƒ";
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´Ø¹Ø±Ø§Øª Ø¨Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²
        if (window.DeviceOrientationEvent) {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                // Ù„Ù„Ø£ÙŠÙÙˆÙ†
                DeviceOrientationEvent.requestPermission().then(state => {
                    if (state === 'granted') window.addEventListener('deviceorientation', updateCompass, true);
                });
            } else {
                // Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ (Ù†Ø³ØªØ®Ø¯Ù… absolute Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ)
                window.addEventListener('deviceorientationabsolute', updateCompass, true);
                window.addEventListener('deviceorientation', updateCompass, true);
            }
        }
        animate();
    }, () => { dirText.innerText = "ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (GPS)"; });

    function updateCompass(e) {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨Ø¯Ù‚Ø©
        let heading = e.webkitCompassHeading || e.alpha;
        
        if (e.absolute === false && !e.webkitCompassHeading) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù†Ø®Ø¨Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            dirText.innerText = "Ø§Ù„Ù…Ø³ØªØ´Ø¹Ø± ØºÙŠØ± Ø¯Ù‚ÙŠÙ‚ØŒ Ø­Ø±Ùƒ Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø±Ù‚Ù… 8";
        }

        if (heading !== null) {
            // Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: alpha ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙØ± Ø¹Ù†Ø¯ Ø§ØªØ¬Ø§Ù‡ Ù…Ø¹ÙŠÙ†ØŒ Ù†Ø­ØªØ§Ø¬ Ù„Ù‚Ù„Ø¨Ù‡
            targetHeading = (e.webkitCompassHeading) ? heading : (360 - heading);
        }
    }

    function animate() {
        let diff = targetHeading - currentHeading;
        if (diff > 180) diff -= 360;
        if (diff < -180) diff += 360;
        currentHeading += diff * lerpSpeed;

        // Ø§Ù„Ø¯ÙˆØ±Ø§Ù†: Ø²Ø§ÙˆÙŠØ© Ù…ÙƒØ© - Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const finalRotation = qiblaAngle - currentHeading;
        pivot.style.transform = `rotate(${finalRotation}deg)`;

        const checkMatch = Math.abs((finalRotation % 360 + 360) % 360);
        if (checkMatch < 5 || checkMatch > 355) {
            kaabaImg.classList.add('perfect');
            dirText.innerText = "Ø£Ù†Øª Ø¨Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø© âœ…";
            dirText.style.color = "var(--green)";
        } else {
            kaabaImg.classList.remove('perfect');
            dirText.innerText = "ÙˆØ¬Ù‡ Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ù„Ø³Ù‡Ù…";
            dirText.style.color = "var(--dark)";
        }
        requestAnimationFrame(animate);
    }
</script>
</body>
</html>